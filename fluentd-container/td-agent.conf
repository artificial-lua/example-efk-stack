<match td.*.*>
  @type tdlog
  @id output_td
  apikey YOUR_API_KEY

  auto_create_table
  <buffer>
    @type file
    path /var/log/td-agent/buffer/td
  </buffer>

  <secondary>
    @type file
    path /var/log/td-agent/failed_records
  </secondary>
</match>

## match tag=debug.** and dump to console
<match debug.**>
  @type stdout
  @id output_stdout
</match>

## live debugging agent
<source>
  @type debug_agent
  @id input_debug_agent
  bind 127.0.0.1
  port 24230
</source>

# In source section, read from tail
<source>
  @type tail
  path /tmp/log.product-*.log
  tag log.product
  format json
</source>
<source>
  @type tail
  path /tmp/log.test-*.log
  tag log.test
  format json
</source>
<source>
  @type tail
  path /tmp/log.dev-*.log
  tag log.dev
  format json
</source>

# In filter section, add context to log
<filter log.*>
  @type record_transformer
  <record>
    context ${tag[1]}
  </record>
</filter>

# In match section, copy to stdout and file
<match log.*>
  @type copy
  <store>
    @type stdout
  </store>
  <store>
    @type file
    path /var/log/td-agent/
  </store>
  <store>
  # Forward logs to another fluentd
    @type forward
    send_timeout 60s
    recover_wait 10s
    hard_timeout 120s
    <server>
      name fluentd_receiver
      host "#{ENV['LOGGING_DESTINATION_HOST']}"
      port "#{ENV['LOGGING_DESTINATION_PORT']}"
    </server>
  </store>
</match>